# pw-sql-assigement-3
This is sql assignment provided by pw( physics wallah) in this assignment i use windows function to solve the querys

use mavenmovies;

-- 1 **Rank the customers based on the total amount they've spent on rentals.**

select customer.customer_id ,sum(film.rental_rate) as total_spent
,rank() over(order by sum(film.rental_rate) desc) as customer_rank
from customer
join
rental on customer.customer_id = rental.customer_id
join
inventory as i
on
rental.inventory_id= i.inventory_id
join
film on film.film_id= i.film_id
group by customer.customer_id
order by total_spent;


-- 2. **Calculate the cumulative revenue generated by each film over time.**


select film.film_id,film.title, rental_date,
sum(rental_rate) over(partition by film_id order by rental.rental_date desc) as cumutative_revanue
 from film
join 
inventory  on film.film_id= inventory.film_id
join 
rental on inventory.inventory_id= rental.inventory_id
order by film.film_id;

-- 3 **Determine the average rental duration for each film, considering films with similar lengths.**

select f.film_id, length,avg(rental_duration) over(partition by  f.film_id)as avg_rental_duration from film as f
order by film_id;


-- 4 **Identify the top 3 films in each category based on their rental counts.**

with film_rank as(
select fc.category_id, fc. film_id,f.title,
row_number() over(partition by fc.category_id order by count(r.rental_id)desc) as ranking
from film_category fc
join
film f on fc.film_id= f.film_id
join
inventory i on f.film_id= i.film_id
join
rental r on i.inventory_id = r. inventory_id
group by fc.category_id, fc.film_id,f.title
)
select category_id, film_id, title,ranking from film_rank
where ranking <= 3;

 -- 5 **Calculate the difference in rental counts between each customer's total rentals and the average rentals 
-- across all customers.**

with customerrentaldiff as(
select customer_id , count(rental_id) as total_rentals, avg( count(rental_id))  over() as avg_rental,
count(rental_id) -avg( count(rental_id))  over()
as rental_diffrence from rental
group by customer_id)
select customer_id, total_rentals, avg_rental, rental_diffrence
from customerrentaldiff;


-- 6  **Find the monthly revenue trend for the entire rental store over time.**

with monthlyrevanue as (
select month(payment_date) as month , sum(amount) as total_revanue
from payment
group by month
)
select month, total_revanue , sum(total_revanue)over (order by month)
as comulative_revanue 
from monthlyrevanue;


-- 7**Identify the customers whose total spending on rentals falls within the top 20% of all customers.**

with customer_spending as (
select customer_id,
sum(amount) as total_spending,
rank() over(order by sum(amount)desc) as customer_rank
from payment
group by customer_id
)
select
		customer_id, total_spending
        from customer_spending
        where customer_rank <= (select 0.2 *count(distinct customer_Id) +1
        from customer_spending);
        
	
    -- 8 **Calculate the running total of rentals per category, ordered by rental count.**
        
with category_rental_count as (
 select fc.category_id,count(r.rental_id) as rental_count,
 rank () over (partition by fc.category_id order by count(r.rental_id)desc)
 as rental_rank
 from film_category fc
 join
 rental r on fc.film_id = r.inventory_id
 group by fc.category_id
 )
 select 
		category_id,
        rental_count,
        sum(rental_count) over (order by rental_rank) as runing_total
        from category_rental_count 
        order by rental_rank;
        

-- 9. **Find the films that have been rented less than the average rental count for their respective categories.**

 with film_rental as(
 select fc.film_id ,
 fc.category_id,
 count(rental_id) as rental_count,
 avg(count(rental_id)) over(partition by category_id) as avg_rental_count
 from film_category as fc
 join
 rental r on fc.film_id= r.inventory_id
 group by fc.film_id,fc.category_id)
 select 
 film_id,
 category_id,
rental_count,
avg_rental_count
from film_rental
where rental_count< avg_rental_count;

 -- 10. **Identify the top 5 months with the highest revenue and display the revenue generated in each month.**

WITH MonthlyRevenue AS (
    SELECT
        DATE_FORMAT(payment_date, '%Y-%m') AS month,
        SUM(amount) AS total_revenue
    FROM
        payment
    GROUP BY
        DATE_FORMAT(payment_date, '%Y-%m')
)
SELECT
    month,
    total_revenue
FROM
    MonthlyRevenue
ORDER BY
    total_revenue DESC
LIMIT 5;
 
